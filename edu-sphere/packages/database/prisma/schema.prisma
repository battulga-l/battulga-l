generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                    String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                  String         @db.VarChar(255)
  slug                  String         @unique @db.VarChar(100)
  type                  String         @db.VarChar(50)
  status                String         @default("active") @db.VarChar(20)
  settings              Json?
  subscriptionPlan      String?        @default("free") @map("subscription_plan") @db.VarChar(50)
  subscriptionExpiresAt DateTime?      @map("subscription_expires_at") @db.Timestamptz(6)
  createdAt             DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt             DateTime?      @map("deleted_at") @db.Timestamptz(6)
  classes               Class[]
  courses               Course[]
  notifications         Notification[]
  users                 User[]

  @@index([slug])
  @@index([type])
  @@index([status])
  @@map("tbl_organizations")
}

model User {
  id                  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId      String         @map("organization_id") @db.Uuid
  email               String         @unique @db.VarChar(255)
  role                String         @db.VarChar(50)
  firstName           String?        @map("first_name") @db.VarChar(100)
  lastName            String?        @map("last_name") @db.VarChar(100)
  avatarUrl           String?        @map("avatar_url")
  phone               String?        @db.VarChar(20)
  dateOfBirth         DateTime?      @map("date_of_birth") @db.Date
  gender              String?        @db.VarChar(10)
  address             String?
  status              String         @default("active") @db.VarChar(20)
  settings            Json?
  lastLoginAt         DateTime?      @map("last_login_at") @db.Timestamptz(6)
  createdAt           DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime?      @map("deleted_at") @db.Timestamptz(6)
  password            String?        @db.VarChar(255)
  recordedAttendances Attendance[]   @relation("RecordedByUser")
  attendanceRecords   Attendance[]   @relation("StudentAttendance")
  instructedCourses   Course[]       @relation("CourseInstructor")
  enrollments         Enrollment[]
  notifications       Notification[]
  gradedSubmissions   Submission[]   @relation("GradedByUser")
  submissions         Submission[]
  organization        Organization   @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@index([status])
  @@index([id], map: "idx_tbl_users_id")
  @@map("tbl_users")
}

model Course {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  title          String       @db.VarChar(255)
  slug           String       @db.VarChar(255)
  description    String?
  thumbnailUrl   String?      @map("thumbnail_url")
  category       String?      @db.VarChar(100)
  level          String?      @db.VarChar(50)
  language       String       @default("mn") @db.VarChar(10)
  durationHours  Int?         @map("duration_hours")
  price          Decimal      @default(0) @db.Decimal(10, 2)
  isPublished    Boolean      @default(false) @map("is_published")
  publishedAt    DateTime?    @map("published_at") @db.Timestamptz(6)
  instructorId   String?      @map("instructor_id") @db.Uuid
  settings       Json?
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime?    @map("deleted_at") @db.Timestamptz(6)
  classes        Class[]
  instructor     User?        @relation("CourseInstructor", fields: [instructorId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  lessons        Lesson[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([instructorId])
  @@index([category])
  @@index([isPublished])
  @@map("tbl_courses")
}

model Class {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  courseId       String       @map("course_id") @db.Uuid
  name           String       @db.VarChar(255)
  code           String?      @db.VarChar(50)
  academicYear   String?      @map("academic_year") @db.VarChar(20)
  semester       String?      @db.VarChar(20)
  startDate      DateTime?    @map("start_date") @db.Date
  endDate        DateTime?    @map("end_date") @db.Date
  schedule       Json?
  maxStudents    Int?         @map("max_students")
  status         String       @default("active") @db.VarChar(20)
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime?    @map("deleted_at") @db.Timestamptz(6)
  attendances    Attendance[]
  course         Course       @relation(fields: [courseId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  enrollments    Enrollment[]

  @@index([organizationId])
  @@index([courseId])
  @@index([status])
  @@index([academicYear])
  @@map("tbl_classes")
}

model Enrollment {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  classId     String    @map("class_id") @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  status      String    @default("active") @db.VarChar(20)
  enrolledAt  DateTime  @default(now()) @map("enrolled_at") @db.Timestamptz(6)
  completedAt DateTime? @map("completed_at") @db.Timestamptz(6)
  progress    Int       @default(0)
  grade       Decimal?  @db.Decimal(5, 2)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  class       Class     @relation(fields: [classId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([classId, userId])
  @@index([classId])
  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@map("tbl_enrollments")
}

model Lesson {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  courseId        String       @map("course_id") @db.Uuid
  parentId        String?      @map("parent_id") @db.Uuid
  title           String       @db.VarChar(255)
  slug            String       @db.VarChar(255)
  description     String?
  content         String?
  contentType     String?      @map("content_type") @db.VarChar(50)
  orderIndex      Int?         @map("order_index")
  durationMinutes Int?         @map("duration_minutes")
  isFree          Boolean      @default(false) @map("is_free")
  resources       Json?
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime?    @map("deleted_at") @db.Timestamptz(6)
  assessments     Assessment[]
  course          Course       @relation(fields: [courseId], references: [id])
  parent          Lesson?      @relation("LessonHierarchy", fields: [parentId], references: [id])
  children        Lesson[]     @relation("LessonHierarchy")

  @@index([courseId])
  @@index([parentId])
  @@index([courseId, orderIndex])
  @@index([contentType])
  @@map("tbl_lessons")
}

model Assessment {
  id               String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  lessonId         String       @map("lesson_id") @db.Uuid
  title            String       @db.VarChar(255)
  description      String?
  type             String       @db.VarChar(50)
  totalPoints      Decimal?     @map("total_points") @db.Decimal(10, 2)
  passingScore     Decimal?     @map("passing_score") @db.Decimal(10, 2)
  timeLimitMinutes Int?         @map("time_limit_minutes")
  attemptsAllowed  Int          @default(1) @map("attempts_allowed")
  questions        Json?
  isPublished      Boolean      @default(false) @map("is_published")
  dueDate          DateTime?    @map("due_date") @db.Timestamptz(6)
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt        DateTime?    @map("deleted_at") @db.Timestamptz(6)
  lesson           Lesson       @relation(fields: [lessonId], references: [id])
  submissions      Submission[]

  @@index([lessonId])
  @@index([type])
  @@index([isPublished])
  @@index([dueDate])
  @@map("tbl_assessments")
}

model Submission {
  id            String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  assessmentId  String     @map("assessment_id") @db.Uuid
  userId        String     @map("user_id") @db.Uuid
  answers       Json?
  files         Json?
  score         Decimal?   @db.Decimal(10, 2)
  feedback      String?
  status        String     @default("submitted") @db.VarChar(20)
  attemptNumber Int        @default(1) @map("attempt_number")
  submittedAt   DateTime?  @map("submitted_at") @db.Timestamptz(6)
  gradedAt      DateTime?  @map("graded_at") @db.Timestamptz(6)
  gradedBy      String?    @map("graded_by") @db.Uuid
  createdAt     DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  assessment    Assessment @relation(fields: [assessmentId], references: [id])
  grader        User?      @relation("GradedByUser", fields: [gradedBy], references: [id])
  user          User       @relation(fields: [userId], references: [id])

  @@index([assessmentId])
  @@index([userId])
  @@index([status])
  @@index([userId, assessmentId])
  @@map("tbl_submissions")
}

model Attendance {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  classId    String   @map("class_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  date       DateTime @db.Date
  status     String   @db.VarChar(20)
  notes      String?
  recordedBy String   @map("recorded_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)
  class      Class    @relation(fields: [classId], references: [id])
  recorder   User     @relation("RecordedByUser", fields: [recordedBy], references: [id])
  user       User     @relation("StudentAttendance", fields: [userId], references: [id])

  @@unique([classId, userId, date])
  @@index([classId])
  @@index([userId])
  @@index([date])
  @@index([classId, date])
  @@index([status])
  @@map("tbl_attendance")
}

model Notification {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizationId String       @map("organization_id") @db.Uuid
  userId         String       @map("user_id") @db.Uuid
  title          String       @db.VarChar(255)
  message        String?
  type           String       @db.VarChar(50)
  category       String?      @db.VarChar(50)
  isRead         Boolean      @default(false) @map("is_read")
  readAt         DateTime?    @map("read_at") @db.Timestamptz(6)
  data           Json?
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  organization   Organization @relation(fields: [organizationId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([userId, isRead])
  @@index([organizationId])
  @@index([type])
  @@index([category])
  @@map("tbl_notifications")
}
